<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Upload file</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>
	<div class="container">
		<div class="row justify-content-center">
			<div class="col col-md-6 card mt-5 p-3">
				<form id="upload-form" action="upload.php" method="post" enctype="multipart/form-data">
					<div class="form-group">
						<label for="name">File Name</label>
						<input name="upload-name" type="text" id="name" class="form-control">
					</div>
					<div class="form-group">
						<div class="custom-file">
							<input name="upload-file" type="file" class="custom-file-input" id="upload-file">
							<label class="custom-file-label" for="upload-file">Choose file</label>
						</div>
					</div>
					<div class="form-group">
                        <input type="hidden" name="page" value="exercise2.php">
						<button type="submit" class="btn btn-primary">Upload</button>
					</div>
                    <div class="form-group">
                        <div class="progress" style="height:10px">
                            <div id="progressBar" class="progress-bar bg-success" style="width:0%"></div>
                        </div>
					</div>
					<div class="form-group">
						<div class="alert alert-danger" id="alert">Error</div>
					</div>
				</form>
			</div>
		</div>
	</div>
    
<script>
    let fileTypes = ['txt', 'doc', 'docx', 'xls', 'xlsx', 'jpg', 'png', 'mp3', 'mp4', 'pdf', 'rar', 'zip']
    let fileLimit = 524288000 //500 MB = 524288000 Bytes
    // Add the following code if you want the name of the file appear on select
    $(document).ready(function() {
        $("#alert").hide();
    })
    
    $(".custom-file-input").on("change", function () {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });

    document.querySelector("#upload-file").addEventListener("change", e => {
        var filename = $(e.target).val().split("\\").pop();
        var filetype = filename.split(".")[1];
        var filesize = e.target.files[0].size;
        
        //Ktra name va size
        if (!fileTypes.includes(filetype)) {
            $("#addAlert").removeClass("alert-success");
            $("#addAlert").addClass("alert-danger");
            $("#alert").html("This file type is not allowed");
            $("#alert").show();
        } else {
            if (filesize>fileLimit) {
                $("#addAlert").removeClass("alert-success");
                $("#addAlert").addClass("alert-danger");
                $("#alert").html("File exceeds the maximum allowed size");
                $("#alert").show();
            } else {
                $("#alert").hide();
            }
        }
    })

    document.getElementById("upload-form").addEventListener("submit", e=> {
        e.preventDefault();
        
        let progressBar = document.querySelector("#progressBar");
        progressBar.style.width = '0%';

        let name = document.querySelector("#name").value;
        let inputfile = document.querySelector("#upload-file");

        if (name.length===0 || inputfile.files.length===0) {
            $("#addAlert").removeClass("alert-success");
            $("#addAlert").addClass("alert-danger");
            $("#alert").html("Input is invalid");
            $("#alert").show();
            return;
        }
        
        let file = inputfile.files[0];
        let fd = document.getElementById("upload-form");
        let data = new FormData(fd);

        let xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('progress', e=> {
            let loaded = e.loaded;
            let total = e.total;
            let progress = loaded * 100/total;
            let percent = Math.round(progress);
            progressBar.style.width = progress + '%';
        })
        xhr.open('POST', 'upload.php', true);
        xhr.send(data);
    })
</script>
</body>

</html>